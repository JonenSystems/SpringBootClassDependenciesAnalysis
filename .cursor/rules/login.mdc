---
alwaysApply: false
---
## 1. 基本機能要件

### 1.1. 認証機能
| 項目 | 内容 |
|------|------|
| **認証方式** | フォームベース認証（Spring Security） |
| **認証対象** | 管理者ユーザー（ADMINロール） |
| **パスワード暗号化** | BCrypt（開発環境：強度10、本番環境：強度12） |
| **セッション管理** | HttpSession（Cookieベース、30分タイムアウト、SameSite/HttpOnly） |
| **ログイン画面** | `/admin/login` |
| **ログイン処理URL** | `POST /admin/login` |
| **ログアウトURL** | `/admin/logout` |

### 1.2 アクセス制御
| 項目 | 内容 |
|------|------|
| **保護対象URL** | `/admin/**`（管理者機能全般） |
| **必要権限** | `ROLE_ADMIN` |
| **公開URL** | `/admin/login`, `/images/**`, `/css/**`, `/js/**`, `/h2-console/**`（開発環境のみ） |
| **その他URL** | 認証不要 |

### 1.3 セキュリティ要件
| 項目 | 内容 |
|------|------|
| **CSRF保護** | 有効（H2コンソール除く） |
| **セッション固定攻撃対策** | ログイン成功時のセッションID再生成 |
| **パスワードポリシー** | BCrypt暗号化必須、平文保存禁止 |
| **セッションタイムアウト** | 30分 |
| **Cookie設定** | http-only=true, same-site=strict |
| **パスワード検証** | BCrypt matches()で検証 |
| **同時セッション制限** | 同一ユーザー1セッションまで |

## 2. 詳細機能要件

### 2.1 ログイン機能
- ユーザー名・パスワードによる認証（Spring Security）
- 認証失敗時のエラーメッセージ表示
- 認証成功時の最終ログイン時刻更新
- セッション固定攻撃対策（セッションID再生成）
- **ログイン成功後のリダイレクト先：`/admin`（ダッシュボード）**

### 2.2 ログアウト機能
- セッション情報の完全削除
- ログアウト完了メッセージ表示
- ログイン画面へのリダイレクト

### 2.3 管理者ユーザー管理機能
- 管理者ユーザーの一覧表示（今後拡張予定）
- 管理者ユーザーの作成・編集・削除（今後拡張予定）
- パスワードの暗号化保存（BCrypt）
- ユーザー状態の有効/無効管理
- 最終ログイン時刻の記録

### 2.4 パスワード管理機能
- BCryptハッシュ生成（開発環境用）
- パスワード検証テスト（開発環境用）
- パスワード変更時の暗号化
- 既存パスワードの保持（変更時のみ暗号化）

## 3. 画面要件

### 3.1 ログイン画面
| 項目 | 内容 |
|------|------|
| **URL** | `/admin/login` |
| **入力項目** | ユーザー名、パスワード |
| **エラー表示** | 認証失敗時のメッセージ |
| **メッセージ表示** | ログアウト完了メッセージ、セッション期限切れメッセージ |
| **リダイレクト先** | 認証成功時は `/admin`（ダッシュボード） |

### 3.2 管理者ダッシュボード
| 項目 | 内容 |
|------|------|
| **URL** | `/admin` |
| **表示内容** | 注文統計、在庫不足商品一覧 |
| **ナビゲーション** | 商品管理、注文管理、顧客管理へのリンク |

## 4. データ要件

### 4.1 管理者ユーザーテーブル
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL,
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP,
    last_login TIMESTAMP
);
```

### 4.2 初期データ例
```sql
-- 管理者ユーザーデータ
-- ユーザー名: admin
-- パスワード: admin123
-- BCryptハッシュ: $2a$10$yET5njgbb6SB6975h/MGrOrJXhRZdoiRIsReY8yzZdXBxgVOG4KjS
INSERT INTO users (id, username, password, role, enabled, created_at, updated_at) VALUES
(1, 'admin', '$2a$10$yET5njgbb6SB6975h/MGrOrJXhRZdoiRIsReY8yzZdXBxgVOG4KjS', 'ADMIN', true, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);
```

## 5. 非機能要件

### 5.1 パフォーマンス要件
| 項目 | 内容 |
|------|------|
| **認証処理時間** | 1秒以内 |
| **セッション管理** | メモリ効率的な実装 |
| **データベース接続** | コネクションプール活用 |

### 5.2 可用性要件
| 項目 | 内容 |
|------|------|
| **認証失敗時の処理** | 適切なエラーメッセージ表示 |
| **セッションタイムアウト** | 自動ログアウトと再ログイン要求 |
| **データベース障害** | 適切なエラーハンドリング |

### 5.3 保守性要件
| 項目 | 内容 |
|------|------|
| **ログ出力** | 認証成功/失敗の詳細ログ |
| **設定管理** | 外部設定ファイルによる管理 |
| **テスト容易性** | モック化可能な設計 |

## 6. セキュリティ要件

### 6.1 認証・認可
- **多要素認証**: 将来的な拡張を考慮した設計
- **権限管理**: ロールベースアクセス制御（RBAC）
- **セッション管理**: 安全なセッション処理

### 6.2 データ保護
- **パスワード暗号化**: BCryptによる安全な暗号化
- **個人情報保護**: 必要最小限の情報のみ保存
- **ログ管理**: セキュリティ監査ログの記録

### 6.3 攻撃対策
- **ブルートフォース攻撃**: アカウントロック機能（将来的な実装）
- **セッション固定攻撃**: ログイン成功時のセッションID再生成（実装済み、有効）
- **CSRF攻撃**: CSRFトークンによる保護（Spring Security標準）
- **パスワード攻撃**: BCryptによる安全な暗号化（実装済み）

## 7. 運用要件

### 7.1 監視・ログ
- **認証ログ**: ログイン成功/失敗の記録
- **セッションログ**: セッション作成/破棄の記録
- **エラーログ**: 認証エラーの詳細記録

### 7.2 バックアップ・復旧
- **データベースバックアップ**: 管理者ユーザー情報の定期バックアップ
- **設定ファイルバックアップ**: セキュリティ設定のバックアップ

### 7.3 障害対応
- **認証障害**: 代替認証方式の検討
- **データベース障害**: 認証情報の復旧手順
