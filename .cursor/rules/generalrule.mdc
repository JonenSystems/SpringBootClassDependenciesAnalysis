---
alwaysApply: true
---
# 基本パッケージ構成
以下、パッケージ構造に従い実装を行うこと。
```
パッケージroot
    ├─── controller/（プレゼンテーション層）
    │        └── リクエスト処理・ビュー制御
    │
    ├─── service/（ビジネスロジック層）
    │        ├── ビジネスロジック・トランザクション管理（インターフェース）
    │        └── impl/
    │             └── ビジネスロジック・トランザクション管理（実装クラス）
    │
    ├─── repository/（データアクセス層）
    │        ├── データベース操作（インターフェース）
    │        └── impl/
    │             └── データベース操作（実装クラス）
    │
    ├─── common/（共通部品クラス）
    │        ├── セッション管理など、機能共通で使用する部品（インターフェース）
    │        └── impl/
    │             └── セッション管理など、機能共通で使用する部品（実装クラス）
    │
    ├─── cconfig/（設定クラス）
    │        └── SpringSecurityなどの設定クラス
    │
    ├─── util/（ユーティリティクラス）
    │
    └─── model/（レイヤー間のデータ受け渡し）
            │ 
            ├── form/
            │     └── 画面（テンプレート） - プレゼンテーション層間のデータ受け渡し
            ├── dto/
            │     └── プレゼンテーション層 - ビジネスロジック層間のデータ受け渡し、共通部品クラスへのデータの受け渡し
            └── entity/
                  └── ビジネスロジック層 - 記憶媒体間のデータ受け渡し
```

---

# 依存関係の追加
pom.xmlに以下を追加すること。
| グループID                        | アーティファクトID                | 用途・説明                      | スコープ     | 備考           |
|-----------------------------------|-----------------------------------|---------------------------------|-------------|----------------|
| org.springframework.boot          | spring-boot-starter-thymeleaf     | テンプレートエンジン（Thymeleaf）| （デフォルト）|                |
| org.springframework.boot          | spring-boot-starter-web           | Webアプリケーション              | （デフォルト）|                |
| org.projectlombok                 | lombok                            | コード簡略化（アノテーション）   | （デフォルト）| optional=true  |
| org.springframework.boot          | spring-boot-starter-test          | テスト用スターター               | test        |                |
| org.springframework.boot          | spring-boot-starter-data-jpa      | JPA（データ永続化）。Hibernateも含まれる。 | （デフォルト）|                |
| com.h2database                    | h2                                | インメモリデータベース           | runtime     |                |
| org.springframework.boot          | spring-boot-starter-security      | セキュリティ機能                 | （デフォルト）|                |
| org.springframework.security      | spring-security-test              | セキュリティ関連のテスト         | test        |                |
| com.uber.nullaway                 | nullaway                          | Nullness検証（NullAway）        | compile     | CI必須通過     |
| org.checkerframework              | checker-qual                      | Nullness検証（Checker Framework）| compile     | CI必須通過     |

---

# コーディング仕様
- Mavenプロジェクトとする。
- パッケージは既存の`pom.xml`に記載の情報に従う。
- JavaおよびSpring Boot、Mavenのバージョンは既存の`pom.xml`に従う。
- package宣言は必ず記述する。
- 必要なimport文を記述する。
- **不変性を重視**: デフォルトは不変（immutable）オブジェクトとする
- **値オブジェクトは record を最優先**: 単純なデータ保持には record を使用する
- **フィールドは private final を原則**: 可変性が必要な場合のみ private を許可
- **@Setter の使用は禁止**: DTOも原則不変とする（必要時のみ明示理由をPRに記載）
- **Lombok の限定使用**: どうしてもクラス化が必要な時のみ Lombok を使用
- **ビルダーや全引数コンストラクタ**: @Builder, @AllArgsConstructor のみに限定
- **不変性による設計品質向上**: 不変オブジェクトにより状態遷移や不整合の曖昧さを排除し、データ整合性を保証
- **Null/Optional ポリシー**: メソッド引数・戻り値は非Nullがデフォルト、外部境界のみOptionalを許可
- **Optional使用制限**: Optionalは戻り値のみ、フィールド/引数での使用禁止
- Formクラスのデータ受け渡しは@ModelAttributeで行い、テンプレートではFormクラス経由で値を参照すること。
- 明示的なデータ変換メソッドをFormクラスに実装すること。
- 処理結果DTOによる統一的な結果管理を実装すること。
- バリデーション機能を適切に実装すること。
- 二重送信防止のためPRGパターンによる実装を行うこと。

---

# テスト仕様
- テストメソッド名は英語（半角英数字）のみを使用する。
- Spring Boot 3.4未満では@MockBeanを使用、3.4以降は@ReplaceWithMockも可（ただし依存解決に注意）。
- 各コントローラーの基本動作確認、サービス層のビジネスロジックテスト、formクラスとdtoクラスのデータ変換テスト、データベース接続・初期化確認、画面遷移の動作確認を行うこと。

---


# 三層アーキテクチャの依存関係原則

## 実装における基本原則
- 各層は下位層のみに依存し、上位層には依存しない
- 層を跨いだ直接的な呼び出しは禁止
  - Dependency Injectionを活用してインターフェース経由でアクセス
  - ビジネスロジック層、データアクセス層、共通部品では完全抽象化されたインターフェースと実装クラスの両方を作成し、クラス間のアクセスはインターフェースによるDependency Injectionを活用する
  - 特に、データアクセス層では実装クラスの切替で容易にデータベースの切替が可能な実装にすること。

## 各層の責務と依存関係

### プレゼンテーション層（Controller）
**責務:**
- HTTPリクエスト/レスポンスの処理
- ビュー制御と画面遷移
- FormクラスとDTOクラス間のデータ変換

**許可される依存:**
- Service層のインターフェース（@Autowired）
- Formクラス（@ModelAttribute）
- DTOクラス（引数として受け渡し）
- セッション管理などの共通部品のインターフェース（@Autowired）

**禁止事項:**
- Repository層への直接アクセス
- Entityクラスの直接使用
- 他のControllerクラスへの直接呼び出し
- HttpSessionのセッションデータの直接操作
- セッション管理ロジックの実装

### ビジネスロジック層（Service）
**責務:**
- ビジネスロジックの実装
- トランザクション管理
- 複数のRepositoryの統合
- DTOクラスとEntityクラス間のデータ変換

**許可される依存:**
- Repository層のインターフェース（@Autowired）
- 他のService層のインターフェース（@Autowired）
- Entityクラス（内部処理で使用）
- DTOクラス（引数として受け渡し）

**禁止事項:**
- Controller層への依存
- Formクラスの使用
- コントローラ層接続用インターフェースクラスからRepositoryへの直接アクセス

### データアクセス層（Repository）
**責務:**
- データベース操作の実装
- Entityクラスの永続化
- クエリの実行

**許可される依存:**
- Entityクラス（JPAエンティティ）
- Spring Data JPAのインターフェース

**禁止事項:**
- Service層やController層への依存
- ビジネスロジックの実装
- DTOクラスやFormクラスの使用
- ビジネスロジック層接続用インターフェースクラスからデータベースへの直接アクセス

**実装上の注意点:**
- インターフェースにより完全抽象化し、実装クラスの切替で容易にデータベースの切替が可能な実装にすること。

### その他のクラス
#### 共通部品クラス（common）
**責務:**
- セッション管理、ファイル操作、メール送信、ログ出力など、複数層で共通して使用される機能の提供
- 特定のビジネスロジックに依存しない汎用的な機能の実装
- 各層からの呼び出しに対する統一的なインターフェース提供
- 共通処理の一元化と再利用性の向上
- 状態を持つ処理や複雑な操作の管理（セッション状態、ファイルアップロード状態など）
- 依存関係を持つ処理の管理（外部サービス連携、設定値の管理など）

**許可される依存:**
- 他の共通部品クラスのインターフェース（@Autowired）
- Spring Frameworkの標準クラス（HttpSession、MultipartFile、JavaMailSender等）
- 設定クラス（config/パッケージ内のクラス）
- DTOクラス（データ受け渡し用）
- 外部ライブラリのクラス（Apache Commons、Google Guava等）
- プロパティファイルや設定値

**禁止事項:**
- Controller層、Service層、Repository層への依存
- Entityクラスの直接使用
- Formクラスの使用
- ビジネスロジックの実装
- データベース操作の直接実行
- 画面表示ロジックの実装
- 特定のビジネスドメインに特化した処理の実装

#### ユーティリティクラス（util）
**責務:**
- 共通の操作やヘルパーメソッドを提供するための静的メソッドを集めたクラス
- 純粋関数として動作する処理の提供（入力に対して一意の出力を返す）
- 状態を持たない処理の実装（パスワード生成、文字列操作、日付計算、数値計算など）
- 軽量で高速な処理の提供
- 複数の層で再利用可能な汎用的な処理の集約

**許可される依存:**
- Java標準ライブラリのクラス（String、Date、Math等）
- 外部ライブラリのユーティリティクラス（Apache Commons Lang、Google Guava等）
- 設定値や定数（アプリケーション全体で使用される値）
- 他のユーティリティクラス（循環依存を避ける）

**禁止事項:**
- クラスは原則としてインスタンス化しない
- 状態を持つ処理の実装
- 外部サービスへの依存（データベース、ファイルシステム、ネットワーク等）
- Spring Frameworkのコンポーネントへの依存
- ビジネスロジックの実装
- セッションやリクエストスコープのデータへの依存
- ログ出力や例外処理の実装（呼び出し元に委ねる）

## 層間データ受け渡しの原則

### Form → DTO → Entity の変換フロー
```
画面 → Formクラス → Controller → DTOクラス → Service → Entityクラス → Repository
```

### 各層でのデータ変換責務
- **Controller層**: Formクラス ↔ DTOクラス（明示的な変換）
- **Service層**: DTOクラス ↔ Entityクラス（ビジネスロジック内での変換）
- **Repository層**: Entityクラスのみ扱う

---

# その他設計仕様
## Entity設計

- 各エンティティには`@Table(name="テーブル名")`を明記する。
- リレーションシップは詳細に指定する。
- テーブル名は複数形名詞とする。
- Entityクラスとschema.sqlのDDLは必ず一致させること。
   - 例：OrderDetailエンティティにpriceフィールドがある場合、order_detailsテーブルにもpriceカラムを追加する。

---

## Null/Optional ポリシーに関する詳細規約

### 基本原則
- **メソッド引数・戻り値は非Nullがデフォルト**: nullを返却・受け取りすることを禁止
- **外部境界のみOptionalを許可**: 外部APIやデータベースからの取得時のみOptional使用
- **Optionalは戻り値限定**: フィールドや引数での使用を禁止
- **null安全性保証**: メソッドの戻り値としてnullを返却することを禁止し、コンパイル時・CI時点でnull安全性を保証

### 実装例
```java
// 推奨: 非Null戻り値
public UserDto findUserById(Long id) {
    User user = userRepository.findById(id);
    if (user == null) {
        throw new UserNotFoundException("User not found: " + id);
    }
    return user.toDto();
}

// 推奨: 外部境界でのOptional使用
public Optional<UserDto> findUserByEmail(String email) {
    return userRepository.findByEmail(email)
        .map(User::toDto);
}

// 禁止: フィールドでのOptional使用
public class UserProfile {
    private Optional<String> email; // ❌ 禁止
}

// 禁止: 引数でのOptional使用
public void updateUser(Optional<UserDto> user) { // ❌ 禁止
    // 処理
}
```

### バリデーション
- **引数はValidateで早期失敗**: nullチェックを含む引数検証を実装
- **NPE防止**: nullによるNullPointerExceptionを確実に防止
- **明示的なnull処理**: nullが発生する可能性がある場合は明示的に処理

### CI/CD要件
- **Nullness検証必須**: NullAway/Checker Frameworkによる静的解析をCIで必須通過

---

## 不変性に関する詳細規約

### 値オブジェクトの実装
```java
// 推奨: record を使用
public record UserId(Long value) {
    public UserId {
        if (value == null || value <= 0) {
            throw new IllegalArgumentException("User ID must be positive");
        }
    }
}

// 必要時のみ: クラス化（Lombok限定使用）
@Value
@Builder
@AllArgsConstructor
public class UserProfile {
    private final String name;
    private final String email;
    private final LocalDateTime createdAt;
}
```

### 禁止事項
- **@Setter の使用**: 状態変更による不整合を防ぐため禁止
- **可変フィールド**: 原則 private final のみ許可
- **状態を持つオブジェクト**: 可能な限り不変オブジェクトを使用

### 例外として可変性を許可する場合
- エンティティクラス（JPA要件）
- セッション管理クラス（状態管理が必要）
- キャッシュ管理クラス（状態管理が必要）
- 明示的な理由をPRに記載し、レビューで承認を得ること

---
